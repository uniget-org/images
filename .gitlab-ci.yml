stages:
- build

ubuntu:
  stage: build
  parallel:
    matrix:
    - VERSION:
      - "24.04"
      - "rolling"
      ARCH:
      - "amd64"
      - "arm64"
  services:
  - docker:27.3.1-dind
  image: docker:27.3.1
  before_script:
  - |
    SOURCE_DATE_EPOCH="$(git log -1 --pretty=%ct ubuntu/Dockerfile)"
    export SOURCE_DATE_EPOCH
  - |
    echo "${CI_REGISTRY_PASSWORD}" \
    | docker login "${CI_REGISTRY}" \
        --username "${CI_REGISTRY_USER}" \
        --password-stdin
  script:
  - |
    docker buildx build ubuntu \
        --build-arg VERSION \
        --tag "${CI_REGISTRY_IMAGE}/ubuntu:${VERSION}-${ARCH}" \
        --push
  tags:
  - saas-linux-medium-${ARCH}
